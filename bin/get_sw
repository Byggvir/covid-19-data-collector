#!/bin/bash

# This bash script collects the data from Baden-WÃ¼rttemberg (BW) und Rheinland-Pfalz (RP), DEU
#
# The trailing number /NN/ changes daily (?).
# If the number is wrong, we get an redirekt or an error 404.

DATUM=$(date +%Y%m%d%H%M)
DATADIR=$1
TMPSOURCE=$(mktemp)
T=$(echo `date +%j` | sed 's#^0*##')        # Day in year
D=$(($T-47))                                # Reduce by offset 48
SOURCE=https://datawrapper.dwcdn.net/YU9ZN/$D/

wget -O "$TMPSOURCE" "$SOURCE"

grep 'url=' "$TMPSOURCE"

if [ $? -eq 1 ] 
then
    echo -e "$( \
    cat "$TMPSOURCE" \
    | grep 'chartData: ' \
    | sed 's#\\n#\n#g; s#\\"##g; 1 s#.*chartData: "#N#; ' \
    | sed '$d' \
    | sed 's#;#,#g' \
    )" \
    > $DATADIR/sw-$DATUM.csv
fi

