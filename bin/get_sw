#!/bin/bash

# This bash script collects the data from Baden-WÃ¼rttemberg (BW) und Rheinland-Pfalz (RP), DEU
#
# The trailing number /NN/ changes daily (?).
# If the number is wrong, we get an redirekt or an error 404.

DATUM=$(date +%Y%m%d%H%M)
DATADIR=$1
TMPSOURCE=$(mktemp)

SOURCE=https://datawrapper.dwcdn.net/YU9ZN/
D=""
FOUND=1
while [ $FOUND -eq 1 ]
do 
    wget -O "${TMPSOURCE}" "${SOURCE}$D"
    grep 'url=../../YU9ZN/[0-9]*/' "${TMPSOURCE}"
    if [ $? -eq 0 ]
    then 
      D=$(sed 's#.*/YU9ZN/##; s#/.*#/#' < "${TMPSOURCE}" )
    else
      FOUND=0
    fi
done

if [ $? -eq 1 ] 
then
    echo -e "$( \
    cat "${TMPSOURCE}" \
    | grep 'chartData: ' \
    | sed 's#\\n#\n#g; s#\\"##g; 1 s#.*chartData: "#N#; ' \
    | sed '$d' \
    | sed 's#;#,#g' \
    )" \
    > ${DATADIR}/sw-${DATUM}.csv
fi

